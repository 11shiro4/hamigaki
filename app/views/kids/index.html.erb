<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シャカシャカにっき - ホーム</title>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <%= stylesheet_link_tag 'application', media: 'all' %>
  <style>
    body {
      font-family: 'DotGothic16', sans-serif;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    body.signed-in {
      background: url('<%= asset_path('yawning.png') %>') no-repeat center center fixed;
      background-size: 80% auto;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 120px);
      position: relative;
    }

    ul {
      list-style-type: none;
      padding: 0;
    }

    li {
      margin-bottom: 10px;
    }

    .actions {
      margin-top: 20px;
    }

    .btn-primary {
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 1.2rem;
      color: white;
      cursor: pointer;
      text-shadow: 1px 1px 2px #555;
      transition: background 0.3s;
      text-decoration: none;
    }

    .btn-primary:hover {
      background: #007bff;
    }

    .btn-primary img {
      width: 40px;
      height: 40px;
    }

    .virus-container {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      height: 200px;
      width: 100%;
      position: relative;
      margin-bottom: 20px;
    }

    .virus-img, .star-img {
      width: 40px;
      height: 40px;
      margin: 5px;
      position: absolute;
    }

    footer {
      background-color: #ffc107;
      text-align: center;
      padding: 10px;
      color: white;
    }
  </style>
  <script>
    function randomPositionWithinBounds(minLeft, maxLeft, minTop, maxTop) {
      return {
        left: Math.floor(Math.random() * (maxLeft - minLeft + 1) + minLeft) + 'px',
        top: Math.floor(Math.random() * (maxTop - minTop + 1) + minTop) + 'px'
      };
    }

    function updateIcons(brushingLogsCount) {
      const virusContainer = document.querySelector('.virus-container');
      virusContainer.innerHTML = '';
      const containerWidth = virusContainer.clientWidth;
      const containerHeight = virusContainer.clientHeight;

      const minLeft = containerWidth / 2 - 60;
      const maxLeft = containerWidth / 2 + 60;
      const minTop = containerHeight - 80;
      const maxTop = containerHeight - 40;

      for(let i = 0; i < brushingLogsCount; i++) {
        const starImg = document.createElement('img');
        starImg.src = '<%= asset_path('star-smile.png') %>';
        starImg.classList.add('star-img');
        const position = randomPositionWithinBounds(minLeft, maxLeft, minTop, maxTop);
        starImg.style.left = position.left;
        starImg.style.top = position.top;
        virusContainer.appendChild(starImg);
      }

      for(let i = brushingLogsCount; i < 3; i++) {
        const virusImg = document.createElement('img');
        virusImg.src = '<%= asset_path('virus.png') %>';
        virusImg.classList.add('virus-img');
        const position = randomPositionWithinBounds(minLeft, maxLeft, minTop, maxTop);
        virusImg.style.left = position.left;
        virusImg.style.top = position.top;
        virusContainer.appendChild(virusImg);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      <% if current_kid %>
        updateIcons(<%= current_kid.brushing_logs.where('created_at >= ?', Date.today.beginning_of_day).count %>);
      <% else %>
        updateIcons(0);
      <% end %>
    });
  </script>
</head>
<body class="<%= body_class %>">
  <header>
    <h1>シャカシャカにっき</h1>
  </header>

  <main>
    <ul>
      <% if kid_signed_in? %>
        <li>
          <%= link_to current_kid.nickname, current_kid %>
          <i class="fas fa-home"></i>
        </li>
      <% else %>
        <li>おうちのひとにとうろくしてもらおう▼</li>
      <% end %>
    </ul>

    <div class="actions">
      <% if kid_signed_in? %>
        <%= link_to destroy_kid_session_path, method: :delete, class: "btn-primary" do %>
          <%= image_tag 'logout.png', alt: 'サインアウト', width: 40, height: 40 %>
        <% end %>
      <% else %>
        <%= link_to new_kid_path, class: "btn-primary" do %>
          <%= image_tag 'user.png', alt: 'しんきとうろく', width: 40, height: 40 %>
        <% end %>
        <%= link_to new_kid_session_path, class: "btn-primary" do %>
          <%= image_tag 'log-in.png', alt: 'ログイン', width: 40, height: 40 %>
        <% end %>
      <% end %>
    </div>

    <div class="virus-container">
      <!-- アイコンがJavaScriptによって動的に追加されます -->
    </div>
  </main>

  <footer>
    <p>© 2025 シャカシャカにっき All Rights Reserved.</p>
  </footer>
</body>
</html>
